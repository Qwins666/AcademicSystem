"use strict";(self["webpackChunkacademic_management_frontend"]=self["webpackChunkacademic_management_frontend"]||[]).push([[367],{4930:function(e,a,t){t.d(a,{$y:function(){return l},BQ:function(){return d},E1:function(){return r},ES:function(){return n},IE:function(){return u},J0:function(){return o},Kg:function(){return c},qP:function(){return s},zW:function(){return v}});var i=t(86);function n(e={}){return(0,i.A)({url:"/activities",method:"get",params:e})}function s(e){return(0,i.A)({url:`/activities/${e}`,method:"get"})}function r(e){return(0,i.A)({url:"/activities",method:"post",data:e})}function o(e,a){return(0,i.A)({url:`/activities/${e}`,method:"put",data:a})}function l(e){return(0,i.A)({url:`/activities/${e}`,method:"delete"})}function c(e){return(0,i.A)({url:`/activities/${e}/register`,method:"post",data:{}})}function u(e){return(0,i.A)({url:`/activities/${e}/cancel-register`,method:"post"})}function d(e){return(0,i.A)({url:`/activities/${e}/certificate`,method:"get"})}function v(e,a="excel"){return(0,i.A)({url:`/activities/${e}/participants/export`,method:"get",params:{type:a},responseType:"blob"})}},5367:function(e,a,t){t.r(a),t.d(a,{default:function(){return $}});var i=t(641),n=t(33);const s={class:"activity-detail"},r={class:"page-header"},o={key:0,class:"detail-card"},l={class:"card-header"},c={class:"status-tag"},u={class:"detail-content"},d={class:"info-row"},v={class:"info-row"},g={class:"value"},k={class:"info-row"},f={class:"value"},p={class:"info-row"},y={class:"value"},m={class:"info-row"},h={class:"value"},L={class:"info-row"},D={class:"value"},T={class:"info-row"},w={class:"value"},E={class:"info-row description"},C={class:"value"},b={class:"card-footer"},R={key:1,class:"loading-container"};function _(e,a,t,_,I,P){const A=(0,i.g2)("el-button"),N=(0,i.g2)("el-tag"),U=(0,i.g2)("el-card"),W=(0,i.g2)("el-skeleton");return(0,i.uX)(),(0,i.CE)("div",s,[(0,i.Lk)("div",r,[a[3]||(a[3]=(0,i.Lk)("h2",null,"活动详情",-1)),(0,i.bF)(A,{type:"primary",onClick:_.handleBack},{default:(0,i.k6)(()=>[...a[2]||(a[2]=[(0,i.eW)("返回列表",-1)])]),_:1},8,["onClick"])]),_.loading?((0,i.uX)(),(0,i.CE)("div",R,[(0,i.bF)(W,{rows:10,animated:""})])):((0,i.uX)(),(0,i.CE)("div",o,[(0,i.bF)(U,{shadow:"hover"},{header:(0,i.k6)(()=>[(0,i.Lk)("div",l,[(0,i.Lk)("h3",null,(0,n.v_)(_.activity.title),1),(0,i.Lk)("div",c,[(0,i.bF)(N,{type:_.getStatusTag(_.activity.status)},{default:(0,i.k6)(()=>[(0,i.eW)((0,n.v_)(_.getStatusName(_.activity.status)),1)]),_:1},8,["type"])])])]),default:(0,i.k6)(()=>[(0,i.Lk)("div",u,[(0,i.Lk)("div",d,[a[4]||(a[4]=(0,i.Lk)("span",{class:"label"},"活动类型：",-1)),(0,i.bF)(N,{type:_.getTypeTag(_.activity.type)},{default:(0,i.k6)(()=>[(0,i.eW)((0,n.v_)(_.getTypeName(_.activity.type)),1)]),_:1},8,["type"])]),(0,i.Lk)("div",v,[a[5]||(a[5]=(0,i.Lk)("span",{class:"label"},"主办方：",-1)),(0,i.Lk)("span",g,(0,n.v_)(_.activity.organizer),1)]),(0,i.Lk)("div",k,[a[6]||(a[6]=(0,i.Lk)("span",{class:"label"},"活动地点：",-1)),(0,i.Lk)("span",f,(0,n.v_)(_.activity.location),1)]),(0,i.Lk)("div",p,[a[7]||(a[7]=(0,i.Lk)("span",{class:"label"},"开始时间：",-1)),(0,i.Lk)("span",y,(0,n.v_)(_.formatDateTime(_.activity.startTime)),1)]),(0,i.Lk)("div",m,[a[8]||(a[8]=(0,i.Lk)("span",{class:"label"},"结束时间：",-1)),(0,i.Lk)("span",h,(0,n.v_)(_.formatDateTime(_.activity.endTime)),1)]),(0,i.Lk)("div",L,[a[9]||(a[9]=(0,i.Lk)("span",{class:"label"},"报名截止时间：",-1)),(0,i.Lk)("span",D,(0,n.v_)(_.formatDateTime(_.activity.registrationDeadline)),1)]),(0,i.Lk)("div",T,[a[10]||(a[10]=(0,i.Lk)("span",{class:"label"},"参与人数：",-1)),(0,i.Lk)("span",w,(0,n.v_)(_.activity.currentParticipants)+" / "+(0,n.v_)(_.activity.maxParticipants),1)]),(0,i.Lk)("div",E,[a[11]||(a[11]=(0,i.Lk)("span",{class:"label"},"活动描述：",-1)),(0,i.Lk)("div",C,(0,n.v_)(_.activity.description),1)])]),(0,i.Lk)("div",b,["STUDENT"===_.userRole&&_.hasRegistered&&_.activity&&_.activity.registrationDeadline&&new Date(_.activity.registrationDeadline)>new Date&&"COMPLETED"!==_.activity.status?((0,i.uX)(),(0,i.Wv)(A,{key:0,type:"info",onClick:_.handleCancelJoin,loading:_.joinLoading},{default:(0,i.k6)(()=>[...a[12]||(a[12]=[(0,i.eW)("取消报名",-1)])]),_:1},8,["onClick","loading"])):"STUDENT"===_.userRole&&_.canJoin(_.activity)?((0,i.uX)(),(0,i.Wv)(A,{key:1,type:"primary",onClick:_.handleJoin,loading:_.joinLoading},{default:(0,i.k6)(()=>[...a[13]||(a[13]=[(0,i.eW)("立即报名",-1)])]),_:1},8,["onClick","loading"])):(0,i.Q3)("",!0),"STUDENT"===_.userRole&&_.hasRegistered&&_.activity&&"COMPLETED"===_.activity.status?((0,i.uX)(),(0,i.Wv)(A,{key:2,type:"success",onClick:_.handleGenerateCertificate,loading:_.joinLoading},{default:(0,i.k6)(()=>[...a[14]||(a[14]=[(0,i.eW)("生成参赛证明",-1)])]),_:1},8,["onClick","loading"])):(0,i.Q3)("",!0),"STUDENT"!==_.userRole&&_.activity&&"COMPLETED"===_.activity.status?((0,i.uX)(),(0,i.CE)(i.FK,{key:3},[(0,i.bF)(A,{type:"success",onClick:a[0]||(a[0]=e=>_.handleDownloadParticipants("excel"))},{default:(0,i.k6)(()=>[...a[15]||(a[15]=[(0,i.eW)("下载参赛名单(Excel)",-1)])]),_:1}),(0,i.bF)(A,{type:"primary",onClick:a[1]||(a[1]=e=>_.handleDownloadParticipants("pdf"))},{default:(0,i.k6)(()=>[...a[16]||(a[16]=[(0,i.eW)("下载参赛名单(PDF)",-1)])]),_:1})],64)):(0,i.Q3)("",!0)])]),_:1})]))])}var I=t(953),P=t(5220),A=t(6278),N=t(163),U=t(4930),W={name:"ActivityDetail",setup(){const e=(0,P.rd)(),a=(0,P.lq)(),t=(0,A.Pj)(),n=(0,I.KR)(!0),s=(0,I.KR)(!1),r=(0,I.KR)({}),o=(0,I.KR)(!1),l=(0,i.EW)(()=>t.getters.userRole),c=(0,i.EW)(()=>t.getters.userId||3),u=e=>{const a={LECTURE:"讲座",COMPETITION:"赛事",TRAINING:"培训"};return a[e]||e},d=e=>{const a={LECTURE:"primary",COMPETITION:"success",TRAINING:"warning"};return a[e]||"info"},v=e=>{const a={DRAFT:"草稿",PUBLISHED:"已发布",CANCELLED:"已取消",COMPLETED:"已完成"};return a[e]||e},g=e=>{const a={DRAFT:"info",PUBLISHED:"success",CANCELLED:"danger",COMPLETED:"warning"};return a[e]||"info"},k=e=>{if(!e)return"-";const a=new Date(e);return isNaN(a.getTime())?e:a.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})},f=()=>{if(console.log("判断报名状态 - 活动ID:",r.value.id,"用户ID:",c.value),!r.value||!r.value.id)return console.log("活动对象不存在或ID无效"),!1;if(void 0!==r.value.hasRegistered)return console.log("使用后端返回的hasRegistered字段:",r.value.hasRegistered),r.value.hasRegistered;if(r.value.registeredUsers&&Array.isArray(r.value.registeredUsers)){const e=r.value.registeredUsers.includes(c.value);return console.log("通过registeredUsers检查结果:",e),e}if(r.value.registrations&&Array.isArray(r.value.registrations)){const e=r.value.registrations.some(e=>e.userId===c.value);return console.log("通过registrations检查结果:",e),e}return!1},p=e=>"STUDENT"===l.value&&"PUBLISHED"===e.status&&new Date(e.registrationDeadline)>new Date&&!o.value,y=async()=>{n.value=!0;try{const t=a.params.id;console.log("加载活动详情 - 活动ID:",t),console.log("当前登录用户ID:",c.value,"角色:",l.value);const i=await(0,U.qP)(t);if(200===i.code){r.value=i.data||{},console.log("活动数据:",r.value),console.log("用户角色:",l.value),console.log("用户ID:",c.value),console.log("活动ID:",r.value.id);const e=f();console.log("用户报名状态:",e),o.value=e,console.log("报名截止时间:",r.value.registrationDeadline),console.log("是否已过截止时间:",new Date(r.value.registrationDeadline)<=new Date),console.log("canJoin返回结果:",p(r.value))}else N.nk.error(i.message||"加载活动详情失败"),e.push("/dashboard/activities")}catch(t){console.error("加载活动详情失败:",t),N.nk.error("加载活动详情失败"),e.push("/dashboard/activities")}finally{n.value=!1}},m=()=>{e.push("/dashboard/activities")},h=async()=>{s.value=!0;try{if(!r.value.id)return void N.nk.error("活动信息错误，无法报名");if(new Date(r.value.registrationDeadline)<=new Date)return void N.nk.warning("报名已截止");if(r.value.currentParticipants>=r.value.maxParticipants)return void N.nk.warning("活动人数已满");if(o.value)return void N.nk.warning("您已报名该活动");const e=await(0,U.Kg)(r.value.id);200===e.code||e.success?(N.nk.success(e.message||"报名成功"),o.value=!0,setTimeout(()=>{y()},500)):N.nk.error(e.message||"报名失败")}catch(e){console.error("报名失败:",e);const a=e.response?.data?.message||e.message||"报名失败，请稍后重试";N.nk.error(a)}finally{s.value=!1}},L=async()=>{s.value=!0;try{if(!r.value.id)return void N.nk.error("活动信息错误，无法取消报名");if(!o.value)return void N.nk.warning("您尚未报名该活动");const e=await(0,U.IE)(r.value.id);200===e.code||e.success?(N.nk.success(e.message||"取消报名成功"),o.value=!1,setTimeout(()=>{y()},500)):N.nk.error(e.message||"取消报名失败")}catch(e){console.error("取消报名失败:",e);const a=e.response?.data?.message||e.message||"取消报名失败，请稍后重试";N.nk.error(a)}finally{s.value=!1}},D=async()=>{s.value=!0;try{if(!r.value.id)return void N.nk.error("活动信息错误，无法生成参与证明");if(!o.value)return void N.nk.warning("您尚未报名该活动，无法生成参与证明");if("COMPLETED"!==r.value.status)return void N.nk.warning("活动尚未完成，无法生成参与证明");const a=await(0,U.BQ)(r.value.id);200===a.code||a.success?e.push(`/dashboard/activities/${r.value.id}/certificate`):N.nk.error(a.message||"参与证明生成失败")}catch(a){console.error("生成参与证明失败:",a);const e=a.response?.data?.message||a.message||"生成参与证明失败，请稍后重试";N.nk.error(e)}finally{s.value=!1}},T=async e=>{try{const a=await(0,U.zW)(r.value.id,e),t=a.data||a,i=new Blob([t],{type:"excel"===e?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"application/pdf"}),n=window.URL.createObjectURL(i),s=document.createElement("a");s.href=n,s.download=`活动参与者名单_${r.value.id}_${(new Date).getTime()}.${"excel"===e?"xlsx":"pdf"}`,document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),window.URL.revokeObjectURL(n)},100),N.nk.success("下载成功")}catch(a){console.error("下载失败:",a);const e=a.response?.data?.message||a.message||"下载失败，请稍后重试";N.nk.error(e)}};return(0,i.sV)(()=>{y()}),{loading:n,joinLoading:s,activity:r,hasRegistered:o,userRole:l,userId:c,isUserRegistered:f,getTypeName:u,getTypeTag:d,getStatusName:v,getStatusTag:g,formatDateTime:k,canJoin:p,handleBack:m,handleJoin:h,handleCancelJoin:L,handleGenerateCertificate:D,handleDownloadParticipants:T}}},S=t(6262);const O=(0,S.A)(W,[["render",_],["__scopeId","data-v-4be355c9"]]);var $=O}}]);
//# sourceMappingURL=367.e32ba724.js.map