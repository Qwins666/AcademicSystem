<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academic.mapper.ProjectMemberMapper">

    <!-- 基础结果集映射 -->
    <resultMap id="BaseResultMap" type="java.util.Map">
        <id column="id" property="id"/>
        <result column="project_id" property="project_id"/>
        <result column="user_id" property="user_id"/>
        <result column="role" property="role"/>
        <result column="join_time" property="join_time"/>
    </resultMap>

    <!-- 基础列名列表 -->
    <sql id="Base_Column_List">
        id, project_id, user_id, role, join_time
    </sql>

    <!-- 插入项目成员 -->
    <insert id="insert" parameterType="java.util.Map">
        INSERT INTO project_member (project_id, user_id, role, join_time, status)
        VALUES (#{project_id}, #{user_id}, #{role}, #{join_time}, 'ACTIVE')
    </insert>

    <!-- 删除项目成员 -->
    <delete id="deleteByProjectAndUser">
        DELETE FROM project_member
        WHERE project_id = #{projectId} AND user_id = #{userId}
    </delete>

    <!-- 更新项目成员角色 -->
    <update id="updateRoleByProjectAndUser">
        UPDATE project_member
        SET role = #{role}
        WHERE project_id = #{projectId} AND user_id = #{userId}
    </update>
    
    <!-- 根据项目ID查询所有成员 -->
    <select id="selectByProjectId" resultMap="BaseResultMap">
        SELECT pm.id, pm.project_id, pm.user_id, pm.role, pm.join_time, u.username as user_name
        FROM project_member pm
        LEFT JOIN user u ON pm.user_id = u.id
        WHERE pm.project_id = #{projectId} AND pm.status = 'ACTIVE'
    </select>
</mapper>